name: Deploy Backend to Fly.io

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-flyio.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-flyio.yml'
  workflow_dispatch:

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  deploy-staging:
    name: Deploy to Staging (PR Preview)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Staging
        working-directory: ./backend
        run: flyctl deploy --config fly.staging.toml --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.STAGING_FLY_API_TOKEN }}

      - name: Comment PR with Staging URL
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš€ Staging Deployment Complete\n\nYour changes have been deployed to the staging environment!\n\n- **App:** gsc-tracking-api-staging\n- **URL:** https://gsc-tracking-api-staging.fly.dev\n- **Swagger:** https://gsc-tracking-api-staging.fly.dev/swagger\n- **Health Check:** https://gsc-tracking-api-staging.fly.dev/api/hello\n- **PR:** #${context.issue.number}\n\n*This staging environment is shared across all PRs. Test your changes and merge when ready.*`
            })

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Production
        working-directory: ./backend
        run: flyctl deploy --config fly.toml --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The backend API has been deployed to production!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **App Name:** gsc-tracking-api" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** iad (Northern Virginia)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://gsc-tracking-api.fly.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check:** https://gsc-tracking-api.fly.dev/api/hello" >> $GITHUB_STEP_SUMMARY
